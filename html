import RPi.GPIO as GPIO
import mysql.connector
import time
import os
from flask import Flask, render_template, send_from_directory, send_file
from threading import Thread
import io

app = Flask(__name__)


BASE_DIR = os.path.dirname(os.path.abspath(__file__))
TEMPLATES_DIR = os.path.join(BASE_DIR, 'templates')
FILE_PATH = os.path.join(TEMPLATES_DIR, 'file_motion.txt')

def Db_connection():
    return mysql.connector.connect(
        host = 'localhost',
        user = 'Embedded_act',
        password = 'bet1234',
        database = 'mydatabase'
    )
pir_sensor_pin = 26  
buzzer_pin = 20    

GPIO.setmode(GPIO.BCM)
GPIO.setwarnings(False)
GPIO.setup(pir_sensor_pin, GPIO.IN)
GPIO.setup(buzzer_pin, GPIO.OUT)

def captured_image(imagePath):
    with open(imagePath, 'rb') as image_file:
        image_data = image_file.read()

    conz = Db_connection()
    cursor = conz.cursor()
    cursor.execute("INSERT INTO images (image_data) VALUES (%s)", (image_data,))
    conz.commit()
    conz.close()

def write_data_to_file(file_path, data):
    with open(file_path, 'a') as file:
        file.write(data)
        file.flush()

# Motion detection function
def motion_detection():
    counter = 0

    try:
        while True:
            if GPIO.input(pir_sensor_pin): 
                print("Motion Detected") 
                write_data_to_file(FILE_PATH, '1\n') 
                GPIO.output(buzzer_pin, GPIO.HIGH)   

                captured_image('path_to_your_image/motion_detected.jpg')
            else:
                print("No Motion") 
                write_data_to_file(FILE_PATH, '0\n') 
                GPIO.output(buzzer_pin, GPIO.LOW)    

            counter += 1

           
            if counter >= 100:
                counter = 0
                print("Resetting file after 100 entries")
                with open(FILE_PATH, 'w') as file:
                    pass  

            time.sleep(1)  

@app.route('/')
def index():
    return render_template('index1.html')


@app.route('/file_motion.txt')
def get_file_motion():
    return send_from_directory(TEMPLATES_DIR, 'file_motion.txt')

def recent_image():
    conz = Db_connection()
    cursor = conz.cursor()
    cursor.execute("SELECT image_data FROM images ORDER BY uploaded_at DESC LIMIT 1")
    image_data =cursor.fetchone()[0]
    conz.close()
    return send_file(
        io.BytesIO(image_data),
        mimetype = 'image/jpg',
        as_attachment_filename = 'recent_image.jpg'
    )
if __name__ == "__main__":
    
    motion_thread = Thread(target=motion_detection)
    motion_thread.start()

    
    app.run(host='0.0.0.0', port=5000, debug=True)

