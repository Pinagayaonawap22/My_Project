let tempHumidityChart;
let distanceChart;
let temperatureUnit = 'C'; // Default temperature unit

// Functions for temperature conversion
function convertToFahrenheit(celsius) {
    return (celsius * 9/5) + 32;
}

function convertToKelvin(celsius) {
    return celsius + 273.15;
}

async function fetchDataAndUpdateCharts() {
    try {
        // Fetch data from server
        const response = await fetch('/Raspi_data');
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        const data = await response.json();

        const time = new Date();

        // Process temperature and humidity data
        let tempCelsius = data.temperature;
        let humidity = data.humidity;
        let temp;

        switch (temperatureUnit) {
            case 'C':
                temp = tempCelsius;
                break;
            case 'F':
                temp = convertToFahrenheit(tempCelsius);
                break;
            case 'K':
                temp = convertToKelvin(tempCelsius);
                break;
        }

        document.getElementById('temptext').textContent = `${temp.toFixed(2)}`;
        document.getElementById('tempUnit').textContent = temperatureUnit;
        document.getElementById('humiditytext').textContent = `${humidity.toFixed(2)}`;

        // Update Temperature & Humidity Chart
        if (tempHumidityChart) {
            if (tempHumidityChart.data.labels.length > 500) {
                tempHumidityChart.data.labels.shift();
                tempHumidityChart.data.datasets[0].data.shift();
                tempHumidityChart.data.datasets[1].data.shift();
            }
            tempHumidityChart.data.labels.push(time);
            tempHumidityChart.data.datasets[0].data.push(temp);
            tempHumidityChart.data.datasets[1].data.push(humidity);
            tempHumidityChart.update();
        } else {
            const ctxTempHumid = document.getElementById('tempHumidityChart').getContext('2d');
            tempHumidityChart = new Chart(ctxTempHumid, {
                type: 'line',
                data: {
                    labels: [time],
                    datasets: [
                        {
                            label: `Temperature (${temperatureUnit})`,
                            data: [temp],
                            borderColor: 'red',
                            fill: false
                        },
                        {
                            label: 'Humidity (%)',
                            data: [humidity],
                            borderColor: 'blue',
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'second'
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    }
                }
            });
        }

        // Update Distance Chart
        if (distanceChart) {
            if (distanceChart.data.labels.length > 500) {
                distanceChart.data.labels.shift();
                distanceChart.data.datasets[0].data.shift();
            }
            distanceChart.data.labels.push(time);
            distanceChart.data.datasets[0].data.push(data.distance);
            distanceChart.update();
        } else {
            const ctxDistance = document.getElementById('distanceChart').getContext('2d');
            distanceChart = new Chart(ctxDistance, {
                type: 'line',
                data: {
                    labels: [time],
                    datasets: [{
                        label: 'Distance (cm)',
                        data: [data.distance],
                        borderColor: 'green',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'second'
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Distance (cm)'
                            }
                        }
                    }
                }
            });
        }

    } catch (error) {
        console.error('Error fetching the data:', error);
    }
}

function toggleTemperatureUnit() {
    switch (temperatureUnit) {
        case 'C':
            temperatureUnit = 'F';
            document.getElementById('toggleUnitButton').textContent = 'Switch to Kelvin';
            break;
        case 'F':
            temperatureUnit = 'K';
            document.getElementById('toggleUnitButton').textContent = 'Switch to Celsius';
            break;
        case 'K':
            temperatureUnit = 'C';
            document.getElementById('toggleUnitButton').textContent = 'Switch to Fahrenheit';
            break;
    }
    fetchDataAndUpdateCharts(); // Update charts with new unit
}

fetchDataAndUpdateCharts();
setInterval(fetchDataAndUpdateCharts, 2000);
document.getElementById('toggleUnitButton').addEventListener('click', toggleTemperatureUnit);
