import RPi.GPIO as GPIO
import mysql.connector
import time
import os
import cv2
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.base import MIMEBase
from email.mime.text import MIMEText
from email import encoders
from flask import Flask, render_template, send_from_directory, request, send_file, Response
import io
from multiprocessing import Process

app = Flask(__name__)

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
TEMPLATES_DIR = os.path.join(BASE_DIR, 'templates')
FILE_PATH = os.path.join(TEMPLATES_DIR, 'file_motion.txt')

def Db_connection():
    try:
        connection = mysql.connector.connect(
            host='localhost',
            user='Embedded_act',
            password='bet1234',
            database='mydatabase'
        )
        print("Database connection successful")
        return connection
    except mysql.connector.Error as err:
        print(f"Database connection error: {err}")
        return None

pir_sensor_pin = 26  
buzzer_pin = 20    
button_pin = 16

GPIO.setmode(GPIO.BCM)
GPIO.setwarnings(False)
GPIO.setup(pir_sensor_pin, GPIO.IN)
GPIO.setup(buzzer_pin, GPIO.OUT)
GPIO.setup(button_pin, GPIO.IN, pull_up_down=GPIO.PUD_UP)  # Pull-up resistor

sensor_active = True

def capture_image():
    cap = cv2.VideoCapture(0)
    ret, frame = cap.read()
    if ret:
        image_path = 'captured_image.jpg'
        cv2.imwrite(image_path, frame)
        cap.release()
        print(f"Image captured and saved at {image_path}")
        return image_path
    cap.release()
    print("Failed to capture image")
    return None

def send_test_email(image_path):
    sender_email = "encoderactivity@gmail.com"
    receiver_email = "pinagayaotonton@gmail.com"
    password = "wfaf mumd yskg xwvx"  # Use your app password here
    
    msg = MIMEMultipart()
    msg['From'] = sender_email
    msg['To'] = receiver_email
    msg['Subject'] = "Captured Image by Motion Sensor"

    body = "A motion was detected, and the image is attached."
    msg.attach(MIMEText(body, 'plain'))

    with open(image_path, 'rb') as image_file:
        part = MIMEBase('application', 'octet-stream')
        part.set_payload(image_file.read())
        encoders.encode_base64(part)
        part.add_header('Content-Disposition', f'attachment; filename={os.path.basename(image_path)}')
        msg.attach(part)

    try:
        with smtplib.SMTP('smtp.gmail.com', 587) as server:
            server.starttls()
            server.login(sender_email, password)
            server.send_message(msg)
        print("Email sent successfully!")
    except Exception as e:
        print(f"Failed to send email: {e}")

def send_image_to_db(image_path):
    with open(image_path, 'rb') as image_file:
        image_data = image_file.read()

    conz = Db_connection()
    if conz:
        cursor = conz.cursor()
        cursor.execute("INSERT INTO images (image_data) VALUES (%s)", (image_data,))
        conz.commit()
        conz.close()
        print("Image data saved to database.")
    else:
        print("Failed to save image data to database due to connection error.")

def write_data_to_file(file_path, data):
    with open(file_path, 'a') as file:
        file.write(data)
        file.flush()
        
@app.route('/push_button', methods=['POST'])
def push_button():
    global sensor_active
    sensor_active = not sensor_active
    state = "active" if sensor_active else "inactive"
    print(f"Sensor state changed: {state}")  # Log the state change
    return {'status': state}

def motion_detection():
    counter = 0
    global sensor_active
    last_capture_time = 0
    capture_interval = 10

    while True:
        if not GPIO.input(button_pin):  # Button pressed (active low)
            sensor_active = not sensor_active
            time.sleep(0.5)

        if sensor_active:
            if GPIO.input(pir_sensor_pin):
                time_dur = time.time()
                print("Motion Detected") 
                write_data_to_file(FILE_PATH, '1\n') 
                GPIO.output(buzzer_pin, GPIO.HIGH)
                
                if time_dur - last_capture_time > capture_interval:
                    image_path = capture_image()
                    if image_path:
                        send_image_to_db(image_path)
                        send_test_email(image_path) 
                        os.remove(image_path)
                        last_capture_time = time_dur

                time.sleep(10)
            else:
                print("No Motion") 
                write_data_to_file(FILE_PATH, '0\n') 
                GPIO.output(buzzer_pin, GPIO.LOW)    
        else:
            print("Sensor is inactive")
            time.sleep(1)

        counter += 1

        if counter >= 100:
            counter = 0
            print("Resetting file after 100 entries")
            with open(FILE_PATH, 'w') as file:
                pass  

        time.sleep(5)  

@app.route('/')
def index():
    return render_template('index1.html')

@app.route('/gallery')
def gallery():
    conz = Db_connection()
    cursor = conz.cursor()
    cursor.execute("SELECT image_data FROM images WHERE id IN (1, 2, 3, 4, 5)")
    results = cursor.fetchall()
    conz.close()

    images = []
    for result in results:
        images.append(f"data:image/jpeg;base64,{base64.b64encode(result[0]).decode('utf-8')}")

    # Ensure we have exactly 5 images, filling with None if less than 5
    while len(images) < 5:
        images.append(None)

    return render_template('index1.html', images=images)

@app.route('/capture_image', methods=['POST'])
def capture_image_route():
    image_path = capture_image()
    if image_path:
        send_image_to_db(image_path)
        send_test_email(image_path)
        os.remove(image_path)
        return {'status': 'image_captured'}
    return {'status': 'capture_failed'}

@app.route('/file_motion.txt')
def get_file_motion():
    return send_from_directory(TEMPLATES_DIR, 'file_motion.txt')

@app.route('/recent_image')
def recent_image():
    conz = Db_connection()
    cursor = conz.cursor()
    cursor.execute("SELECT image_data FROM images ORDER BY uploaded_at DESC LIMIT 1")
    result = cursor.fetchone()
    conz.close()
    
    if result:
        image_data = result[0]
        return send_file(io.BytesIO(image_data), mimetype='image/jpeg')
    else:
        return "No image available"

@app.route('/check_image')
def check_image():
    conz = Db_connection()
    cursor = conz.cursor()
    cursor.execute("SELECT COUNT(*) FROM images ORDER BY uploaded_at DESC LIMIT 1")
    result = cursor.fetchone()
    conz.close()

    if result[0] > 0:
        return {'status': 'new_image_available'}
    else:
        return {'status': 'no_image'}

def run_flask():
    app.run(host='0.0.0.0', port=5066, debug=True)

if __name__ == "__main__":
    motion_process = Process(target=motion_detection)
    motion_process.start()
    run_flask()
