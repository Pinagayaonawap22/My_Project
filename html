<script>
    let tempHumidityChart;
    let distanceChart;
    let temperatureUnit = 'C';

    function convertToFahrenheit(celsius) {
        return (celsius * 9/5) + 32;
    }

    function convertToKelvin(celsius) {
        return celsius + 273.15;
    }

    function fetchDataAndUpdateCharts() {
        fetch('/dht_data')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                let tempCelsius = data.temperature;
                let humidity = data.humidity;
                let distance = data.distance;
                let temp;

                switch (temperatureUnit) {
                    case 'C':
                        temp = tempCelsius;
                        break;
                    case 'F':
                        temp = convertToFahrenheit(tempCelsius);
                        break;
                    case 'K':
                        temp = convertToKelvin(tempCelsius);
                        break;
                }

                document.getElementById('temptext').textContent = `${temp.toFixed(2)}`;
                document.getElementById('tempUnit').textContent = temperatureUnit;
                document.getElementById('humiditytext').textContent = `${humidity.toFixed(2)}`;
                document.getElementById('distance1').textContent = `${distance.toFixed(2)} cm`;

                if (tempHumidityChart) {
                    tempHumidityChart.data.datasets[0].data.push(temp);
                    tempHumidityChart.data.datasets[1].data.push(humidity);

                    const maxDataPoints = 500;
                    if (tempHumidityChart.data.datasets[0].data.length > maxDataPoints) {
                        tempHumidityChart.data.datasets[0].data.shift();
                        tempHumidityChart.data.datasets[1].data.shift();
                    }

                    tempHumidityChart.data.labels.push('');
                    if (tempHumidityChart.data.labels.length > maxDataPoints) {
                        tempHumidityChart.data.labels.shift();
                    }

                    tempHumidityChart.update();
                } else {
                    const ctxTempHumidity = document.getElementById('tempHumidityChart').getContext('2d');
                    tempHumidityChart = new Chart(ctxTempHumidity, {
                        type: 'line',
                        data: {
                            labels: [''],
                            datasets: [
                                {
                                    label: `Temperature (${temperatureUnit})`,
                                    data: [temp],
                                    borderColor: 'red',
                                    fill: false
                                },
                                {
                                    label: 'Humidity (%)',
                                    data: [humidity],
                                    borderColor: 'blue',
                                    fill: false
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Time'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Value'
                                    }
                                }
                            }
                        }
                    });
                }

                if (distanceChart) {
                    distanceChart.data.datasets[0].data.push(distance);

                    const maxDataPoints = 500;
                    if (distanceChart.data.datasets[0].data.length > maxDataPoints) {
                        distanceChart.data.datasets[0].data.shift();
                    }

                    distanceChart.data.labels.push('');
                    if (distanceChart.data.labels.length > maxDataPoints) {
                        distanceChart.data.labels.shift();
                    }

                    distanceChart.update();
                } else {
                    const ctxDistance = document.getElementById('distanceChart').getContext('2d');
                    distanceChart = new Chart(ctxDistance, {
                        type: 'line',
                        data: {
                            labels: [''],
                            datasets: [{
                                label: 'Distance (cm)',
                                data: [distance],
                                borderColor: 'green',
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Time'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Distance'
                                    }
                                }
                            }
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching the data:', error);
            });
    }

    function toggleTemperatureUnit() {
        switch (temperatureUnit) {
            case 'C':
                temperatureUnit = 'F';
                document.getElementById('toggleUnitButton').textContent = 'Switch to Kelvin';
                break;
            case 'F':
                temperatureUnit = 'K';
                document.getElementById('toggleUnitButton').textContent = 'Switch to Celsius';
                break;
            case 'K':
                temperatureUnit = 'C';
                document.getElementById('toggleUnitButton').textContent = 'Switch to Fahrenheit';
                break;
        }
        fetchDataAndUpdateCharts(); // Update charts with new unit
    }

    fetchDataAndUpdateCharts();
    setInterval(fetchDataAndUpdateCharts, 2000);
    document.getElementById('toggleUnitButton').addEventListener('click', toggleTemperatureUnit);
</script>
