#include "DHT.h"

#define PHsensor A0
#define OFFSET 0.00
#define DhtPin 3
#define flowpin 4
#define SAMPLING_INTERVAL 1000

volatile int flowpulsecount = 0;
float flowRate;
unsigned long previousMillis = 0;
const int watersensor = 2;
int waterdata =0;

#define DHTTYPE DHT22
DHT dht(DhtPin, DHTTYPE);

float voltagePh;
float Phvalue;
unsigned long Phtime = 0;

void setup() {
  Serial.begin(9600);
  pinMode(watersensor, INPUT);
  pinMode(PHsensor, INPUT);
  pinMode(flowpin, INPUT);
  attachInterrupt(digitalPinToInterrupt(flowpin), countFlow, RISING);
  dht.begin();
}

void loop() {
  waterdata  = digitalRead(watersensor);
  float tempdata = dht.readTemperature();
  float humidData = dht.readHumidity();
  unsigned long currentmillis = millis();

  if (isnan(tempdata)|| isnan(humidData)){
    Serial.print("Temperature: ");
    Serial.println("No Sensor");
    Serial.print("Humidity: ");
    Serial.print(humidData);
    Serial.println("No Sensor");
  }

    Serial.print("Temperature: ");
    Serial.print(tempdata);
    Serial.println(" C");
    Serial.print("Humidity: ");
    Serial.print(humidData);
    Serial.println(" %");

  if (waterdata == 1){
      Serial.print("Water status: ");
      Serial.println("Mayroon ng Tubig");
  }else{
      Serial.print("Water status: ");
      Serial.println("Walang Tubig");
  }
  if (millis()- Phtime > SAMPLING_INTERVAL){
    Phtime = millis();

    int Phdata = analogRead(PHsensor);
    voltagePh =Phdata * (5.0 / 1023.0);
    Phvalue = 7 + ((2.5 - voltagePh) / 0.18);

    Phvalue += OFFSET;

    Serial.print("Ph level: ");
    Serial.println(Phvalue);
  }
  if (currentmillis - previousMillis >= 1000){
    previousMillis = currentmillis;
    flowRate = (flowpulsecount / 7.5);
    flowpulsecount =0;
  
    Serial.print("Flow rate: ");
    Serial.print(flowRate);
     Serial.println(" L/min");
  }
  delay(2000);
}

void countFlow() {
  flowpulsecount++;  
}
